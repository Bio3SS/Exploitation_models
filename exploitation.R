options(device.ask.default=grDevices::dev.interactive(orNone = TRUE))
explEq = function(time, vars, parms){

	# These should be done one level up
	sigF <- with(as.list(parms), ifelse(is.null(Kf), 0, 1/Kf))
	sigE <- with(as.list(parms), ifelse(is.null(Ke), 0, 1/Ke))
	rho <- with(as.list(parms), ifelse(is.null(satF), 0, 1/satF))

	fH <- with(as.list(c(vars, parms)),
		ifelse(time>harvTime, fHarv, 0)
	)
	eH <- with(as.list(c(vars, parms)),
		ifelse(time>harvTime, eHarv, 0)
	)

	phi <- with(as.list(c(vars, parms)),
		1/(1+Nf*rho)
	)

	Fdot <- with(as.list(c(vars, parms)),
		rf*(1 - Nf*sigF - Ne*phi/Ce)*Nf - fH*Nf
	)
	Edot <- with(as.list(c(vars, parms)),
		de*(Nf*phi/Cf - Ne*sigE - 1)*Ne - eH*Ne
	)
	list(c(Fdot,Edot))
}

explSim = function (Nf, Ne, steps, MaxTime, preTime, parms){
	sim <- as.data.frame(lsoda(
		y = c(Nf=Nf, Ne=Ne),
		times = (0:steps)*(preTime+MaxTime)/steps - preTime,
		func = explEq,
		parms=parms
	))
	return (sim[sim$time>=0, ])
}

explPhasePlot <- function(simlist){
	mlist <- apply(sapply(simlist, function(sim){
		sapply(sim, max)
	}), 1, max)

	plot(NULL, NULL,
		xlab = "Resource",
		ylab = "Exploiter",
		xlim = c(0, mlist[["Nf"]]), ylim=c(0, mlist[["Ne"]])
	)

	sapply(simlist, function(currsim){
		with(currsim, {
			lines(Nf, Ne, lwd=1.5)
			points(Nf[1], Ne[1], cex=1.5)
			steps = length(Nf)
			points(Nf[steps], Ne[steps], pch=16, cex=1.5)
			arrows(Nf[steps/10], Ne[steps/10], Nf[1+steps/10],
				Ne[1+steps/10])
		})
	})

	# Log plot

	plot(NULL, NULL,
		xlab = "Resource",
		ylab = "Exploiter",
		xlim = c(0.1, mlist[["Nf"]]), ylim=c(0.1, mlist[["Ne"]]),
		log="xy"
	)

	sapply(simlist, function(currsim){
		with(currsim, {
			lines(Nf, Ne, lwd=1.5)
			points(Nf[1], Ne[1], cex=1.5)
			steps = length(Nf)
			points(Nf[steps], Ne[steps], pch=16, cex=1.5)
			arrows(Nf[steps/10], Ne[steps/10], Nf[1+steps/10],
				Ne[1+steps/10])
		})
	})
}

explTimePlot <- function(sim, legendSize=1){
	with(sim, {
		plot(time, Nf,
			xlab="Time (years)", 
			ylab = "Population density",
			type = "l", 
			ylim = c(0, max(c(Nf, Ne))), lwd=1.5
		)
		lines(time, Ne, lty=2, lwd=1.5)
		legend("topleft"
			, legend = c("Resource", "Exploiter")
			, lty=1:2, cex=legendSize
		)
	})
}

explPlots = function (Nf=5, Ne=1, satF=NULL, Kf=40, Ke=NULL, rf=2, de=1,
	Ce=2, Cf=5, fHarv=0, eHarv=0, harvTime=10, steps=400, MaxTime=40, 
	preTime=0, plots="b", legendSize=1){
	parms <- list(satF=satF, Kf=Kf, Ke=Ke, rf=rf, de=de, Ce=Ce,
		Cf=Cf, fHarv=fHarv, eHarv=eHarv, harvTime=harvTime
	)
	simlist <- mapply(explSim, Nf, Ne,
		MoreArgs=list(steps=steps, MaxTime=MaxTime,
		preTime=preTime, parms=parms),
		SIMPLIFY=FALSE
	)

	if ((plots=="b") | (plots == "p")){
		explPhasePlot(simlist)
	}

	if ((plots=="b") | (plots == "t")){
		for(sim in simlist){explTimePlot(sim, legendSize=legendSize)}
	}
	# simlist
}
